name: Continuous integration

on: [push]

permissions: write-all

jobs:
  scan:
    name: Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2.3.0
        with:
          projectBaseDir: src
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io

  test:
    name: Tests
    uses: ./.github/workflows/workflow-test.yml
    with:
      publish_coverage_history: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  version:
    name: Version
    uses: ./.github/workflows/workflow-version.yml

  build_scan:
    name: Docker image
    needs: [test, version]
    uses: ./.github/workflows/workflow-docker-build-scan-push.yml
    with:
      image_name: rutkowski/expensesplitter-api
      enable_push: true
      build_context: src
      dockerfile: src/ExpenseSplitter.Api.Presentation/Dockerfile
      release_tag: ${{ needs.version.outputs.release_tag }}
    secrets: inherit
